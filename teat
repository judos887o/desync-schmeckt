local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local LP = Players.LocalPlayer

local fflags = {
    ["DisableDPIScale"] = "True",
    ["S2PhysicsSenderRate"] = "15000",
    ["AngularVelociryLimit"] = "360",
    ["StreamJobNOUVolumeCap"] = "2147483647",
    ["GameNetDontSendRedundantDeltaPositionMillionth"] = "1",
    ["TimestepArbiterOmegaThou"] = "1073741823",
    ["MaxMissedWorldStepsRemembered"] = "-2147483648",
    ["GameNetPVHeaderRotationalVelocityZeroCutoffExponent"] = "-5000",
    ["PlayerHumanoidPropertyUpdateRestrict"] = "False",
    ["PhysicsSenderMaxBandwidthBps"] = "20000",
    ["LargeReplicatorSerializeWrite4"] = "True",
    ["MaxAcceptableUpdateDelay"] = "1",
    ["ServerMaxBandwith"] = "52",
    ["InterpolationFrameRotVelocityThresholdMillionth"] = "5",
    ["GameNetDontSendRedundantNumTimes"] = "1",
    ["StreamJobNOUVolumeLengthCap"] = "2147483647",
    ["CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent"] = "1",
    ["TimestepArbiterHumanoidTurningVelThreshold"] = "1",
    ["MaxTimestepMultiplierAcceleration"] = "2147483647",
    ["SimOwnedNOUCountThresholdMillionth"] = "2147483647",
    ["SimExplicitlyCappedTimestepMultiplier"] = "2147483646",
    ["TimestepArbiterVelocityCriteriaThresholdTwoDt"] = "2147483646",
    ["CheckPVCachedVelThresholdPercent"] = "10",
    ["MaxTimestepMultiplierHumanoid"] = "2147483647",
    ["ReplicationFocusNouExtentsSizeCutoffForPauseStuds"] = "2147483647",
    ["InterpolationFramePositionThresholdMillionth"] = "5",
    ["DebugSendDistInSteps"] = "-2147483648",
    ["LargeReplicatorEnabled9"] = "True",
    ["CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth"] = "1",
    ["LargeReplicatorWrite5"] = "True",
    ["NextGenReplicatorEnabledWrite4"] = "True",
    ["MaxTimestepMultiplierContstraint"] = "2147483647",
    ["SimDefaultHumanoidTimestepMultiplier"] = "150",
    ["MaxTimestepMultiplierBuoyancy"] = "2147483647",
    ["MaxDataPacketPerSend"] = "2147483647",
    ["LargeReplicatorRead5"] = "True",
    ["CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth"] = "1",
    ["TimestepArbiterHumanoidLinearVelThreshold"] = "1",
    ["WorldStepMax"] = "30",
    ["InterpolationFrameVelocityThresholdMillionth"] = "5",
    ["LargeReplicatorSerializeRead3"] = "True",
    ["GameNetPVHeaderLinearVelocityZeroCutoffExponent"] = "-5000",
    ["CheckPVCachedRotVelThresholdPercent"] = "10"
}

local function applyFlags()
    for name, value in pairs(fflags) do
        pcall(setfflag, name, value)
    end
end

local function smartRejoin()
    if #Players:GetPlayers() <= 1 then
        -- Einzelspieler / Leerer Server -> Normaler Teleport
        LP:Kick("Rejoining Server...")
        task.wait()
        TeleportService:Teleport(game.PlaceId, LP)
    else
        -- Voller Server / Public / VIP -> Instance Teleport
        TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LP)
    end
end

local function showRejoinMenu()
    for _, child in pairs(CoreGui:GetChildren()) do
        if child.Name == "SchmecktRejoinUI" then child:Destroy() end
    end

    local sg = Instance.new("ScreenGui", CoreGui)
    sg.Name = "SchmecktRejoinUI"
    sg.IgnoreGuiInset = true
    sg.ResetOnSpawn = false
    
    local Frame = Instance.new("Frame", sg)
    Frame.Size = UDim2.new(0, 320, 0, 160)
    Frame.Position = UDim2.new(0.5, -160, -0.5, 0) 
    Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    Frame.BorderSizePixel = 0
    Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 12)
    
    local Stroke = Instance.new("UIStroke", Frame)
    Stroke.Color = Color3.fromRGB(138, 43, 226)
    Stroke.Thickness = 2
    
    local Title = Instance.new("TextLabel", Frame)
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.Text = "SCHMECKT DESYNC"
    Title.TextColor3 = Color3.fromRGB(138, 43, 226)
    Title.BackgroundTransparency = 1
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 20
    
    local Desc = Instance.new("TextLabel", Frame)
    Desc.Size = UDim2.new(1, -30, 0, 50)
    Desc.Position = UDim2.new(0, 15, 0, 40)
    Desc.Text = "Settings applied. Rejoin required."
    Desc.TextColor3 = Color3.fromRGB(200, 200, 200)
    Desc.BackgroundTransparency = 1
    Desc.TextWrapped = true
    Desc.Font = Enum.Font.Gotham
    Desc.TextSize = 14

    local Rejoin = Instance.new("TextButton", Frame)
    Rejoin.Size = UDim2.new(0, 120, 0, 35)
    Rejoin.Position = UDim2.new(0, 25, 1, -50)
    Rejoin.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    Rejoin.Text = "REJOIN"
    Rejoin.TextColor3 = Color3.new(1, 1, 1)
    Rejoin.Font = Enum.Font.GothamBold
    Instance.new("UICorner", Rejoin).CornerRadius = UDim.new(0, 8)
    
    local Later = Instance.new("TextButton", Frame)
    Later.Size = UDim2.new(0, 120, 0, 35)
    Later.Position = UDim2.new(1, -145, 1, -50)
    Later.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Later.Text = "LATER"
    Later.TextColor3 = Color3.new(1, 1, 1)
    Later.Font = Enum.Font.GothamBold
    Instance.new("UICorner", Later).CornerRadius = UDim.new(0, 8)
    
    TweenService:Create(Frame, TweenInfo.new(0.6, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Position = UDim2.new(0.5, -160, 0.5, -80)}):Play()
    
    Rejoin.MouseButton1Click:Connect(function()
        smartRejoin()
    end)
    
    Later.MouseButton1Click:Connect(function()
        TweenService:Create(Frame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {Position = UDim2.new(0.5, -160, 1.5, 0)}):Play()
        task.wait(0.4)
        sg:Destroy()
    end)
end

applyFlags()

if LP.Character and LP.Character:FindFirstChildOfClass("Humanoid") then
    LP.Character:FindFirstChildOfClass("Humanoid").Health = 0
end

task.wait(1)
showRejoinMenu()
